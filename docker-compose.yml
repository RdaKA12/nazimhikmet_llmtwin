services:
  zenml_server:
    image: python:3.11-slim
    working_dir: /app
    command: >
      sh -lc "
        set -e;
        export DEBIAN_FRONTEND=noninteractive;
        apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*;
        pip install --no-cache-dir 'zenml[server]==0.61.0';
        # run ZenML server in foreground (blocking)
        zenml up --blocking --port 8237 --ip-address 0.0.0.0
      "
    ports:
      - "8237:8237"
    volumes:
      - .:/app
      - zenml_data:/root/.config/zenml
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8237 >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 10m

  mongo:
    image: mongo:7
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  qdrant:
    image: qdrant/qdrant:v1.13.4
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage

  pipeline:
    build:
      context: .
      dockerfile: docker/Dockerfile.pipeline
    
    depends_on:
      zenml_server:
        condition: service_healthy
      mongo:
        condition: service_started
      qdrant:
        condition: service_started
    env_file:
      - .env
    environment:
      # connect pipeline to in-cluster ZenML server
      - ZENML_SERVER_URL=http://zenml_server:8237
      # fallbacks if .env missing
      - MONGO_URL=${MONGO_URL:-mongodb://mongo:27017}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-nazim_text_chunks}
    volumes:
      - .:/app
      - zenml_data:/root/.config/zenml
      - hf_cache:/root/.cache
    command: [ "bash", "-lc", "chmod +x scripts/zenml-wait.sh && scripts/zenml-wait.sh && python -m src.ui.zen_run" ]

  api:
    image: nazim-twin-pipeline:latest
    container_name: api
    depends_on:
      qdrant:
        condition: service_started
    working_dir: /app
    env_file:
      - .env
    environment:
      # Ensure container can reach host's Ollama
      - OLLAMA_API_URL=http://host.docker.internal:11434
    volumes:
      - .:/app
      - hf_cache:/root/.cache
    command: [ "bash", "-lc", "pip install --no-cache-dir -r requirements-api.txt || true; uvicorn src.api.app:app --host 0.0.0.0 --port 8000" ]
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 1m

volumes:
  zenml_data:
  mongo_data:
  qdrant_storage:
  hf_cache:
